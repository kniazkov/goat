import "grammar.goat";

try {

var grammar = new Grammar();

var DIGIT = grammar.createTag("DIGIT");
var PLUS = grammar.createTag("PLUS");
var MUL = grammar.createTag("MUL");
var BINARY = grammar.createTag("BINARY");

var Calculator = {
    calc : $() {
        return new Exception.NotImplemented();
    }
};

var Digit = [Grammar.Terminal, Calculator] -> {
    tag : DIGIT,

    init : $(value) {
        this.value = value;
    },

    buils : $() {
        return String.valueOf(value);
    },
    
    calc : $() {
        return value;
    },

    buildXML : $(elem) {
        elem.attrib.value = value;
    }
};

var Plus = Grammar.Terminal -> {
    tag : PLUS
};

var Mul = Grammar.Terminal -> {
    tag : MUL
};

var Binary = [Grammar.NonTerminal, Calculator] -> {
    tag : BINARY,

    calc : $() {
        var left = base.left[0];
        var right = base.right[0];

        switch(base.center.tag) {
            case PLUS:
                return left.calc() + right.calc();
            case MUL:
                return left.calc() * right.calc();
        }
        return "?";
    }
};

var source = "1+2*3+4*5";
var sequence = grammar.createSequence();

for (var i = 0; i < source.length(); i++) {
    var token;
    switch(source[i]) {
        case '0':
            token = new Digit(0); break;
        case '1':
            token = new Digit(1); break;
        case '2':
            token = new Digit(2); break;
        case '3':
            token = new Digit(3); break;
        case '4':
            token = new Digit(4); break;
        case '5':
            token = new Digit(5); break;
        case '6':
            token = new Digit(6); break;
        case '7':
            token = new Digit(7); break;
        case '8':
            token = new Digit(8); break;
        case '9':
            token = new Digit(9); break;
        case '+':
            token = new Plus(); break;
        case '*':
            token = new Mul(); break;
    }
    sequence.push(token);
}

grammar.add([
    DIGIT <-- MUL --> DIGIT --|> Binary,
    DIGIT || BINARY <-- PLUS --> DIGIT || BINARY --|> Binary
]);

grammar.parse();
var xml = sequence.toXML("ROOT");
println(xml.toString("  "));

println(sequence.iterator().read().calc());

}
catch(e) {
    println(e.trace);
}